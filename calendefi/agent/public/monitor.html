<!DOCTYPE html>
<html>
<head>
    <title>ğŸ”¥ CalendeFi - Live Transaction Monitor</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .status-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .success { border-color: #28a745; background: rgba(40, 167, 69, 0.2); }
        .warning { border-color: #ffc107; background: rgba(255, 193, 7, 0.2); }
        .info { border-color: #17a2b8; background: rgba(23, 162, 184, 0.2); }
        .error { border-color: #dc3545; background: rgba(220, 53, 69, 0.2); }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .transaction-log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        
        .auto-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .event-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        
        .pending { border-left-color: #ffc107; }
        .executed { border-left-color: #28a745; }
        .failed { border-left-color: #dc3545; }
        
        h1, h2 { text-align: center; }
        .highlight { color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>
    <div class="auto-refresh">
        ğŸ”„ Auto-refresh: <span id="countdown">30</span>s
    </div>
    
    <div class="container">
        <h1>ğŸ”¥ CalendeFi Live Monitor</h1>
        <p style="text-align: center;">Real-time monitoring of calendar events and blockchain transactions</p>
        
        <!-- Navigation -->
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="schedule.html" style="color: white; text-decoration: none; padding: 10px 15px; background: rgba(255,255,255,0.2); border-radius: 5px; margin: 0 5px;">ğŸ“… Schedule</a>
            <a href="wallet.html" style="color: white; text-decoration: none; padding: 10px 15px; background: rgba(255,255,255,0.2); border-radius: 5px; margin: 0 5px;">ğŸ’³ Wallets</a>
            <a href="monitor.html" style="color: white; text-decoration: none; padding: 10px 15px; background: rgba(255,255,255,0.2); border-radius: 5px; margin: 0 5px;">ğŸ“Š Monitor</a>
        </div>
        
        <!-- System Status -->
        <div class="status-card" id="systemStatus">
            <h2>ğŸ”§ System Status</h2>
            <div id="statusContent">Loading...</div>
        </div>
        
        <div class="grid">
            <!-- Current Wallet Info -->
            <div class="status-card">
                <h3>ğŸ’³ Wallet Information</h3>
                <div id="walletInfo">Loading...</div>
                <button onclick="refreshWallet()">ğŸ”„ Refresh Wallet</button>
            </div>
            
            <!-- Quick Actions -->
            <div class="status-card">
                <h3>âš¡ Quick Actions</h3>
                <button onclick="openGoogleCalendar()">ğŸ“… Open Google Calendar</button>
                <button onclick="openScheduler()">ğŸ“ Event Scheduler</button>
                <button onclick="executeTestTransaction()">ğŸš€ Test Transaction</button>
                <button onclick="clearLogs()">ğŸ—‘ï¸ Clear Logs</button>
            </div>
        </div>
        
        <!-- Pending Calendar Events -->
        <div class="status-card">
            <h2>ğŸ“… Calendar Events with Transactions</h2>
            <div id="calendarEvents">Loading...</div>
            <button onclick="refreshEvents()">ğŸ”„ Refresh Events</button>
        </div>
        
        <!-- Transaction History -->
        <div class="status-card">
            <h2>ğŸ“Š Recent Transaction Activity</h2>
            <div class="transaction-log" id="transactionLog">
                <div style="color: #aaa;">Monitoring for transactions...</div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="status-card info">
            <h2>ğŸ“– How to Schedule Transactions</h2>
            <div style="line-height: 1.8;">
                <p><strong>ğŸ¯ Method 1: Direct Google Calendar</strong></p>
                <ol>
                    <li>Open <a href="https://calendar.google.com" target="_blank" style="color: #ffd700;">Google Calendar</a></li>
                    <li>Create new event with title: <span class="highlight">"Send 10 APT to 0x1234..."</span></li>
                    <li>Set the date and time when you want the transaction to execute</li>
                    <li>Save the event - CalendeFi will detect and execute it automatically!</li>
                </ol>
                
                <p><strong>ğŸ¯ Method 2: Web Interface</strong></p>
                <ol>
                    <li>Click "Event Scheduler" button above</li>
                    <li>Fill in transaction details and timing</li>
                    <li>Submit to create calendar event automatically</li>
                </ol>
                
                <p><strong>ğŸ“ Supported Transaction Formats:</strong></p>
                <ul>
                    <li><code>Send 10 APT to 0x1234567890abcdef...</code></li>
                    <li><code>Transfer 5.5 APT to alice.apt</code></li>
                    <li><code>Pay 0.1 APT to recipient_address</code></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let refreshCounter = 30;
        let logs = [];
        
        // Auto-refresh countdown
        setInterval(() => {
            refreshCounter--;
            document.getElementById('countdown').textContent = refreshCounter;
            
            if (refreshCounter <= 0) {
                refreshAll();
                refreshCounter = 30;
            }
        }, 1000);
        
        async function refreshAll() {
            await Promise.all([
                checkSystemStatus(),
                refreshWallet(),
                refreshEvents()
            ]);
        }
        
        async function checkSystemStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                const statusDiv = document.getElementById('systemStatus');
                if (data.status === 'healthy') {
                    statusDiv.className = 'status-card success';
                    document.getElementById('statusContent').innerHTML = `
                        <p>âœ… <strong>Agent Status:</strong> Online and healthy</p>
                        <p>ğŸŒ <strong>Network:</strong> ${data.network}</p>
                        <p>ğŸ” <strong>Monitoring:</strong> ${data.monitoring ? 'Active' : 'Inactive'}</p>
                        <p>â° <strong>Last Check:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                    `;
                } else {
                    statusDiv.className = 'status-card error';
                    document.getElementById('statusContent').innerHTML = '<p>âŒ Agent is offline</p>';
                }
            } catch (error) {
                const statusDiv = document.getElementById('systemStatus');
                statusDiv.className = 'status-card error';
                document.getElementById('statusContent').innerHTML = '<p>âŒ Cannot connect to agent</p>';
            }
        }
        
        async function refreshWallet() {
            try {
                const response = await fetch('/aptos/wallet');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('walletInfo').innerHTML = `
                        <p><strong>Address:</strong> <code>${data.wallet.address}</code></p>
                        <p><strong>Balance:</strong> <span class="highlight">${data.wallet.balance} APT</span></p>
                        <p><strong>Network:</strong> ${data.wallet.network}</p>
                        <p><a href="${data.wallet.explorerUrl}" target="_blank">ğŸ”— View on Explorer</a></p>
                    `;
                } else {
                    document.getElementById('walletInfo').innerHTML = `
                        <p>âš ï¸ Wallet not yet created on-chain</p>
                        <p><small>Will be created automatically on first transaction</small></p>
                    `;
                }
            } catch (error) {
                document.getElementById('walletInfo').innerHTML = '<p>âŒ Error loading wallet info</p>';
            }
        }
        
        async function refreshEvents() {
            try {
                const response = await fetch('/aptos/events');
                const data = await response.json();
                
                if (data.success) {
                    const eventsDiv = document.getElementById('calendarEvents');
                    const transactionEvents = data.events.filter(event => 
                        event.parsedTransaction || 
                        (event.summary && /send|transfer|pay/i.test(event.summary))
                    );
                    
                    if (transactionEvents.length > 0) {
                        eventsDiv.innerHTML = transactionEvents.map(event => {
                            const isPast = new Date(event.start) < new Date();
                            const statusClass = isPast ? 'executed' : 'pending';
                            const statusText = isPast ? 'âœ… Executed' : 'â³ Pending';
                            
                            return `
                                <div class="event-item ${statusClass}">
                                    <strong>${event.summary}</strong> ${statusText}<br>
                                    <small>ğŸ“… Scheduled: ${new Date(event.start).toLocaleString()}</small><br>
                                    ${event.parsedTransaction ? `
                                        <small>ğŸ’° ${event.parsedTransaction.amount} ${event.parsedTransaction.token} â†’ ${event.parsedTransaction.recipient}</small>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                    } else {
                        eventsDiv.innerHTML = '<p>No transaction events found. Create one in Google Calendar!</p>';
                    }
                } else {
                    document.getElementById('calendarEvents').innerHTML = '<p>âŒ Error loading calendar events</p>';
                }
            } catch (error) {
                document.getElementById('calendarEvents').innerHTML = '<p>âŒ Error connecting to calendar</p>';
            }
        }
        
        async function executeTestTransaction() {
            addLog('ğŸš€ Executing test transaction...');
            
            try {
                const response = await fetch('/aptos/demo-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: '0.001',
                        token: 'APT',
                        recipient: '0x1',
                        executeNow: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.txHash) {
                    addLog(`âœ… Transaction successful: ${data.txHash}`);
                    addLog(`ğŸ”— Explorer: ${data.explorerUrl}`);
                } else {
                    addLog(`âŒ Transaction failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                addLog(`âŒ Transaction error: ${error.message}`);
            }
        }
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.unshift(`[${timestamp}] ${message}`);
            if (logs.length > 50) logs.pop(); // Keep only last 50 logs
            
            document.getElementById('transactionLog').innerHTML = logs.join('<br>');
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('transactionLog').innerHTML = '<div style="color: #aaa;">Logs cleared.</div>';
        }
        
        function openGoogleCalendar() {
            window.open('https://calendar.google.com', '_blank');
        }
        
        function openScheduler() {
            window.open('/schedule.html', '_blank');
        }
        
        // Initialize
        window.onload = function() {
            refreshAll();
            addLog('ğŸ”„ CalendeFi Monitor started');
        };
    </script>
</body>
</html>